# CLI Testing Dockerfile
# Provides an isolated environment to test stronghold CLI commands
# without affecting the host system's network configuration.
#
# Build: docker build -f Dockerfile.cli-test -t stronghold-cli-test .
# Run:   docker run -it --cap-add=NET_ADMIN stronghold-cli-test

FROM golang:1.25-alpine

# Install dependencies for proxy functionality and testing
RUN apk add --no-cache \
    iptables \
    nftables \
    ip6tables \
    curl \
    bash \
    git \
    ca-certificates \
    pass \
    gnupg

WORKDIR /app

# Copy go mod files first for better caching
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build CLI and proxy binaries
RUN go build -o /usr/local/bin/stronghold ./cmd/cli
RUN go build -o /usr/local/bin/stronghold-proxy ./cmd/proxy

# Set API URL environment variable (uses production API by default)
ENV STRONGHOLD_API_URL=https://api.getstronghold.xyz

# Create entrypoint script that initializes GPG at runtime
RUN printf '#!/bin/bash\nset -e\n\n\
if [ ! -d ~/.gnupg ] || [ ! -f ~/.gnupg/trustdb.gpg ]; then\n\
    echo "Initializing GPG keyring..."\n\
    gpg --batch --passphrase "" --quick-gen-key "Stronghold Test <test@stronghold.local>" default default never 2>/dev/null\n\
    pass init "Stronghold Test" 2>/dev/null\n\
    echo "GPG keyring initialized."\n\
fi\n\n\
gpgconf --kill gpg-agent 2>/dev/null || true\n\
gpg-agent --daemon --allow-preset-passphrase 2>/dev/null || true\n\n\
exec "$@"\n' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
